import{D as J,E as w,F as A,G as X,J as F,n as G}from"./chunk-GS4UQ2EW.js";import{a as tt}from"./chunk-4LXUHWEL.js";import{B as d,Ba as T,Ca as _,D as u,Ua as B,a as Z,sa as $,ta as Q,xa as q}from"./chunk-MS5TNNAU.js";import{o as Y}from"./chunk-EL3WWTSF.js";import{$c as R,Dc as p,Ec as h,Fc as x,Jc as O,Mb as N,Nb as v,Rc as I,Sb as c,Tb as y,Tc as f,Td as V,Va as S,_c as E,ad as j,eb as P,fb as M,fd as K,mc as g,rc as l,sc as W,tc as U}from"./chunk-FSPAMUWJ.js";import{a as m,b,h as H,j as k}from"./chunk-NZGOIL2E.js";k();var z=H(Z());var L=H(tt());var it=["map"];function et(s,C){if(s&1&&x(0,"div",10),s&2){let e=f();l("innerHTML",e.label,v)}}function nt(s,C){if(s&1){let e=O();p(0,"button",11),I("click",function(){P(e);let t=f();return M(t.visibleTooltip=!t.visibleTooltip)}),p(1,"mat-icon"),K(2,"info_outline"),h()()}}function at(s,C){if(s&1&&x(0,"div",12),s&2){let e=C.$implicit;l("innerHTML",e,v)}}function ot(s,C){if(s&1){let e=O();p(0,"tb-history-selector",13),I("timeUpdated",function(t){P(e);let n=f();return M(n.timeUpdated(t))}),h()}if(s&2){let e=f();l("settings",e.settings)("minTime",e.minTime)("maxTime",e.maxTime)("step",e.normalizationStep)("anchors",e.anchors)("useAnchors",e.useAnchors)}}var st=(()=>{class s{constructor(e,i){this.cd=e,this.sanitizer=i,this.interpolatedTimeData=[],this.formattedInterpolatedTimeData=[],this.formattedCurrentPosition=[],this.formattedLatestData=[],this.mainTooltips=[],this.visibleTooltip=!1,this.anchors=[],this.calcTooltip=(t,n)=>{let a=t||this.activeTrip,o=this.settings.useTooltipFunction?_(this.settings.parsedTooltipFunction,[a,n,t.dsIndex]):this.settings.tooltipPattern;return F.parseTemplate(o,a,!0)},this.findFirstHistoricalDataIndexCoordinate=t=>u(t[this.settings.latKeyName])&&u(t[this.settings.lngKeyName])}ngOnInit(){this.widgetConfig=this.ctx.widgetConfig,this.settings=m(m({buttonColor:B(this.widgetConfig.color).setAlpha(.54).toRgbString()},J),this.ctx.settings),this.useAnchors=this.settings.showPoints&&this.settings.usePointAsAnchor,this.settings.parsedPointAsAnchorFunction=T(this.settings.pointAsAnchorFunction,["data","dsData","dsIndex"]),this.settings.parsedTooltipFunction=T(this.settings.tooltipFunction,["data","dsData","dsIndex"]),this.settings.parsedLabelFunction=T(this.settings.labelFunction,["data","dsData","dsIndex"]),this.settings.parsedColorPointFunction=T(this.settings.colorPointFunction,["data","dsData","dsIndex"]),this.normalizationStep=this.settings.normalizationStep;let e=this.ctx.defaultSubscription;e.callbacks.onDataUpdated=()=>{this.historicalData=Q(this.ctx.data).map(a=>this.clearIncorrectFirsLastDatapoint(a)).filter(a=>a.length),this.interpolatedTimeData.length=0,this.formattedInterpolatedTimeData.length=0;let i=this.minTime,t=this.maxTime;this.calculateIntervals();let n=this.calculateCurrentTime(i,t);n!==this.currentTime&&this.timeUpdated(n),this.mapWidget.map.map?.invalidateSize(),this.mapWidget.map.setLoading(!1),this.cd.detectChanges()},e.callbacks.onLatestDataUpdated=()=>{this.formattedLatestData=$(this.ctx.latestData),this.updateCurrentData()}}ngAfterViewInit(){import("./chunk-OKVHLCAI.js").then(e=>{this.mapWidget=new e.MapWidgetController(G.openstreet,!1,this.ctx,this.mapContainer.nativeElement),this.mapResize$=new ResizeObserver(()=>{this.mapWidget.resize()}),this.mapResize$.observe(this.mapContainer.nativeElement)})}ngOnDestroy(){this.mapResize$&&this.mapResize$.disconnect()}timeUpdated(e){this.currentTime=e,this.formattedCurrentPosition=this.interpolatedTimeData.map(i=>i[e]);for(let i=0;i<this.interpolatedTimeData.length;i++)if(d(this.formattedCurrentPosition[i])){let t=Object.keys(this.interpolatedTimeData[i]).map(n=>parseInt(n,10));for(let n=1;n<t.length;n++)if(t[n-1]<e&&t[n]>e){let a=this.interpolatedTimeData[i][t[n-1]],o=this.interpolatedTimeData[i][t[n]],r=w(t[n-1],t[n],e);this.formattedCurrentPosition[i]=m(b(m({},a),{time:e}),A(a,o,this.settings.latKeyName,this.settings.lngKeyName,r));break}}for(let i=0;i<this.interpolatedTimeData.length;i++)d(this.formattedCurrentPosition[i])&&(this.formattedCurrentPosition[i]=this.calculateLastPoints(this.interpolatedTimeData[i],e));this.updateCurrentData()}updateCurrentData(){let e=this.formattedCurrentPosition;this.formattedLatestData.length&&(e=q(this.formattedCurrentPosition,this.formattedLatestData)),this.calcLabel(e),this.calcMainTooltip(e),this.mapWidget&&this.mapWidget.map&&this.mapWidget.map.map&&(this.mapWidget.map.updateFromData(!0,e,this.formattedInterpolatedTimeData,i=>{this.activeTrip=i,this.timeUpdated(this.currentTime),this.cd.markForCheck()}),this.settings.showPoints&&this.mapWidget.map.updatePoints(this.formattedInterpolatedTimeData,this.calcTooltip))}setActiveTrip(){}calculateLastPoints(e,i){let t=Object.keys(e),n=t.findIndex(a=>Number(a)>=i);return n!==-1?Number(t[n])!==i&&n!==0&&n--:n=t.length-1,e[t[n]]}calculateIntervals(){let e=1/0,i=-1/0;if(this.historicalData.forEach(t=>{e=Math.min(t[0].time,e),i=Math.max(t[t.length-1].time,i)}),this.minTime=e,this.maxTime=i,this.historicalData.forEach((t,n)=>{this.interpolatedTimeData[n]=this.interpolateArray(t)}),this.formattedInterpolatedTimeData=this.interpolatedTimeData.map(t=>z.default.values(t)),this.activeTrip||(this.activeTrip=this.interpolatedTimeData.map(t=>t[this.minTime]).filter(t=>t)[0]),this.useAnchors){let t=Object.entries(z.default.union(this.interpolatedTimeData)[0]);this.anchors=t.filter((n,a)=>_(this.settings.parsedPointAsAnchorFunction,[n[1],this.formattedInterpolatedTimeData.map(o=>o[a]),n[1].dsIndex])).map(n=>parseInt(n[0],10))}}calcMainTooltip(e){let i=[];for(let t of e)i.push(this.sanitizer.sanitize(N.HTML,this.calcTooltip(t,e)));this.mainTooltips=i}calcLabel(e){if(this.activeTrip){let i=e[this.activeTrip.dsIndex],t=this.settings.useLabelFunction?_(this.settings.parsedLabelFunction,[i,e,i.dsIndex]):this.settings.label;this.label=this.sanitizer.bypassSecurityTrustHtml(F.parseTemplate(t,i,!0))}}interpolateArray(e){let i={},t=this.settings.latKeyName,n=this.settings.lngKeyName;for(let o of e){let r=o.time,D=this.minTime+Math.ceil((r-this.minTime)/this.normalizationStep)*this.normalizationStep;i[D]=b(m({},o),{minTime:this.minTime!==1/0?(0,L.default)(this.minTime).format("YYYY-MM-DD HH:mm:ss"):"",maxTime:this.maxTime!==-1/0?(0,L.default)(this.maxTime).format("YYYY-MM-DD HH:mm:ss"):"",rotationAngle:this.settings.rotationAngle})}let a=Object.keys(i);for(let o=0;o<a.length-1;o++){if(d(i[a[o+1]][t])||d(i[a[o+1]][n])){for(let r=o+2;r<a.length-1;r++)if(u(i[a[r]][t])||u(i[a[r]][n])){let D=w(Number(a[o]),Number(a[r]),Number(a[o+1]));i[a[o+1]]=m(m({},A(i[a[o]],i[a[r]],t,n,D)),i[a[o+1]]);break}}i[a[o]].rotationAngle+=X(i[a[o]],i[a[o+1]],t,n)}return i}calculateCurrentTime(e,i){return e!==this.minTime||i!==this.maxTime?this.minTime>=this.currentTime||d(this.currentTime)?this.minTime:this.maxTime<=this.currentTime?this.maxTime:this.minTime+Math.ceil((this.currentTime-this.minTime)/this.normalizationStep)*this.normalizationStep:this.currentTime}clearIncorrectFirsLastDatapoint(e){let i=e.findIndex(this.findFirstHistoricalDataIndexCoordinate);if(i===-1)return[];let t=e.length-1;for(t;t>0;t--)if(this.findFirstHistoricalDataIndexCoordinate(e[t])){t++;break}return i>0||t<e.length?e.slice(i,t):e}static{this.\u0275fac=function(i){return new(i||s)(y(V),y(Y))}}static{this.\u0275cmp=S({type:s,selectors:[["trip-animation"]],viewQuery:function(i,t){if(i&1&&E(it,5),i&2){let n;R(n=j())&&(t.mapContainer=n.first)}},inputs:{ctx:"ctx"},decls:10,vars:12,consts:[["map",""],[1,"trip-animation-widget"],["class","trip-animation-label-container",3,"innerHTML",4,"ngIf"],[1,"trip-animation-container","flex","flex-col"],[1,"map"],[1,"trip-animation-info-panel","flex","flex-row"],["class","tooltip-button","mat-mini-fab","","color","primary","aria-label","tooltip",3,"click",4,"ngIf"],[1,"trip-animation-tooltip","md-whiteframe-z4","flex","flex-col"],["style","padding: 10px 0",3,"innerHTML",4,"ngFor","ngForOf"],[3,"settings","minTime","maxTime","step","anchors","useAnchors","timeUpdated",4,"ngIf"],[1,"trip-animation-label-container",3,"innerHTML"],["mat-mini-fab","","color","primary","aria-label","tooltip",1,"tooltip-button",3,"click"],[2,"padding","10px 0",3,"innerHTML"],[3,"timeUpdated","settings","minTime","maxTime","step","anchors","useAnchors"]],template:function(i,t){i&1&&(p(0,"div",1),g(1,et,1,1,"div",2),p(2,"div",3),x(3,"div",4,0),p(5,"div",5),g(6,nt,3,0,"button",6),h(),p(7,"div",7),g(8,at,1,1,"div",8),h()(),g(9,ot,1,6,"tb-history-selector",9),h()),i&2&&(c(),l("ngIf",t.settings.showLabel),c(5),l("ngIf",t.settings.showTooltip),c(),W("background-color",t.settings.tooltipColor)("opacity",t.settings.tooltipOpacity)("color",t.settings.tooltipFontColor),U("trip-animation-tooltip-hidden",!t.visibleTooltip),c(),l("ngForOf",t.mainTooltips),c(),l("ngIf",t.historicalData))},styles:['@charset "UTF-8";.trip-animation-widget[_ngcontent-%COMP%]{position:relative;width:100%;height:100%;font-size:16px;line-height:24px;display:flex;flex-direction:column}.trip-animation-widget[_ngcontent-%COMP%]   .trip-animation-label-container[_ngcontent-%COMP%]{height:24px}.trip-animation-widget[_ngcontent-%COMP%]   .trip-animation-container[_ngcontent-%COMP%]{position:relative;z-index:1;flex:1;width:100%}.trip-animation-widget[_ngcontent-%COMP%]   .trip-animation-container[_ngcontent-%COMP%]   .map[_ngcontent-%COMP%]{width:100%;height:100%}.trip-animation-widget[_ngcontent-%COMP%]   .trip-animation-container[_ngcontent-%COMP%]   .trip-animation-info-panel[_ngcontent-%COMP%]{position:absolute;top:0;right:0;pointer-events:none}.trip-animation-widget[_ngcontent-%COMP%]   .trip-animation-container[_ngcontent-%COMP%]   .trip-animation-info-panel[_ngcontent-%COMP%]   .tooltip-button[_ngcontent-%COMP%]{top:0;left:0;width:32px;min-width:32px;height:32px;min-height:32px;margin:2px;line-height:24px;z-index:999}.trip-animation-widget[_ngcontent-%COMP%]   .trip-animation-container[_ngcontent-%COMP%]   .trip-animation-info-panel[_ngcontent-%COMP%]   .tooltip-button[_ngcontent-%COMP%]   .mat-icon[_ngcontent-%COMP%]{width:24px;height:24px}.trip-animation-widget[_ngcontent-%COMP%]   .trip-animation-container[_ngcontent-%COMP%]   .trip-animation-info-panel[_ngcontent-%COMP%]   .tooltip-button[_ngcontent-%COMP%]   .mat-icon[_ngcontent-%COMP%]   svg[_ngcontent-%COMP%]{width:inherit;height:inherit}.trip-animation-widget[_ngcontent-%COMP%]   .trip-animation-container[_ngcontent-%COMP%]   .trip-animation-tooltip[_ngcontent-%COMP%]{display:flex;overflow:auto;max-height:90%;position:absolute;top:30px;right:0;z-index:1000;padding:5px;background-color:#fff;transition:.3s ease-in-out}.trip-animation-widget[_ngcontent-%COMP%]   .trip-animation-container[_ngcontent-%COMP%]   .trip-animation-tooltip-hidden[_ngcontent-%COMP%]{transform:translate(110%)}']})}}return s})(),Dt=st;export{st as a,Dt as b};
